---
title: "VCF Figure"
author: "Brian Behnken"
date: "2025-08-28"
output: html_document
---

``` {r}
cat("\014") # I like having a clean environment always.
rm(list = ls())

# packages (I use pacman to manage my packages)
pacman::p_load(vcfR, tidyverse)

# Use the final callset created:
vcf_path <- "NILs_chr07dp15.hc.vcf.gz"    # or "NILs.chr07.hc.bcf" # Per depth 15 recall, I changed the file name
vcf <- read.vcfR(vcf_path, verbose = FALSE)

fix <- as_tibble(getFIX(vcf)) |>
  mutate(POS = as.integer(POS), Mb = POS/1e6)

gt  <- extract.gt(vcf, element = "GT")     # sites x samples
samples <- colnames(gt)

# parents (must match sample names in the VCF)
parentA <- "Pv250.dedup.bam"
parentB <- "Pv63H.dedup.bam"

# For my sanity
stopifnot(parentA %in% samples, parentB %in% samples)

# NILs are everything except the two parents
nils <- setdiff(samples, c(parentA, parentB))

allele_from_gt <- function(x) {
  ifelse(is.na(x) | x=="./.", NA,
  ifelse(x %in% c("0/0","0|0"), "REF",
  ifelse(x %in% c("1/1","1|1"), "ALT",
  ifelse(x %in% c("0/1","1/0","0|1","1|0"), "HET", NA))))
}

PA <- allele_from_gt(gt[, parentA])
PB <- allele_from_gt(gt[, parentB])

nils <- setdiff(samples, c(parentA, parentB))

classify_one <- function(s) {
  S <- allele_from_gt(gt[, s])
  case_when(
    !is.na(PA) & !is.na(PB) & PA != PB & S == PA ~ "A",
    !is.na(PA) & !is.na(PB) & PA != PB & S == PB ~ "B",
    S == "HET"                                  ~ "HET",
    TRUE                                        ~ "NEITHER"
  )
}

long <- map_dfr(nils, \(s)
  tibble(sample = s, cls = classify_one(s)) |> bind_cols(fix)
)

# ---- Panel (b): SNP density per 100 kb (all SNPs) ----
bins <- long |>
  mutate(bin = floor(POS/1e5)*1e5) |>
  count(sample, bin, name="SNPs") |>
  mutate(Mb = bin/1e6)

snpdensity <- ggplot(bins, aes(x=Mb, y=SNPs)) +
  geom_area() +
  facet_grid(sample ~ ., switch="y") +
  labs(x="Position (Mb)", y="SNP density (per 100 kb)",
       title="Chr07 SNP density across NILs") +
  theme_linedraw()

snpdensity

# Optional: a version of (b) showing only B-like SNP density
bins_B <- long |>
  filter(cls == "B") |>
  mutate(bin = floor(POS/1e5)*1e5) |>
  count(sample, bin, name="B_SNPs") |>
  mutate(Mb = bin/1e6)

bsnpdensity <- ggplot(bins_B, aes(x=Mb, y=B_SNPs)) +
  geom_area() +
  facet_grid(sample ~ ., switch="y") +
  labs(x="Position (Mb)", y="B-like SNP density (per 100 kb)",
       title="Chr07 B-like SNP density across NILs") +
  theme_linedraw()

bsnpdensity
# Save
ggsave("snp_density.eps", snpdensity)
ggsave("bsnp_density.eps", bsnpdensity)


# Now I want to overlay the SNP plots so each one is a different colour

pacman::p_load(forcats)

# I need to keep these sample levels consistent across all plots
sample_levels <- c("Pv4B.dedup.bam","Pv4C.dedup.bam","Pv7A.dedup.bam",
                   "Pv7D.dedup.bam","Pv8A.dedup.bam","Pv8C.dedup.bam")

# Parameters
bin_size <- 1e5   # 100 kb bins (adjust to 5e4, 1e4 etc. for different resolution)

# Defensive checks
if(!"POS" %in% names(long)) stop("long must contain POS column (bp coordinates).")
if(!"cls" %in% names(long)) stop("long must contain cls column (A/B/HET/NEITHER).")
if(!"sample" %in% names(long)) stop("long must contain sample column.")

missing_samples <- setdiff(sample_levels, unique(long$sample))
if(length(missing_samples) > 0) {
  warning("These samples are in sample_levels but not present in long: ",
          paste(missing_samples, collapse = ", "))
}

# Build binned counts per sample x bin x cls (A vs B)
bins_raw <- long %>%
  filter(!is.na(cls) & cls %in% c("A","B")) %>%
  mutate(bin = floor(POS / bin_size) * bin_size) %>%
  count(sample, bin, cls, name = "n")

# Create a regular bin sequence (seq is robust)
bin_seq <- seq(min(bins_raw$bin, na.rm=TRUE),
               max(bins_raw$bin, na.rm=TRUE),
               by = bin_size)

# Complete the grid so missing sample/bin/cls combos become zeros
bins_complete <- bins_raw %>%
  complete(sample = sample_levels,
           bin = bin_seq,
           cls = c("A","B"),
           fill = list(n = 0)) %>%
  arrange(sample, bin, cls) %>%
  mutate(Mb = bin / 1e6,
         sample = factor(sample, levels = sample_levels))

# Quick peek
print(head(bins_complete))
print(range(bins_complete$bin))

# Chr07: 7,407,405–7,413,437 from IGV
roi <- c(7.300000, 7.500000)  # Mb


# Overlayed area plot (A and B semi-transparent)
snpdensity_overlay <- ggplot(bins_complete, aes(x = Mb, y = n, fill = cls)) +
  geom_area(position = "identity", alpha = 1, color = NA) +
  facet_grid(sample ~ ., switch = "y") +
  scale_fill_manual(values = c(A="#595a5b", B="#bf7049"), name = NULL,
                    labels = c("A-like","B-like")) +
  labs(x = "Position (Mb)",
       y = paste0("SNP count (per ", format(bin_size, scientific = FALSE), " bp)"),
       title = "Chr07: A-like (blue) vs B-like (red) SNP density") +
  theme_linedraw() +
  annotate("rect", ymin = -Inf, ymax = Inf,
           xmin = roi[1], xmax = roi[2],
           fill = "grey80", alpha = 1, color = NA) +
  theme(panel.grid.minor = element_blank())

print(snpdensity_overlay)

ggsave("SNP_density_overlay.eps", snpdensity_overlay)

```

``` {r no "Neither" SNPS}

# map GT -> {REF, ALT, HET, NA}
allele_from_gt <- function(x){
  ifelse(is.na(x) | x=="./.", NA,
  ifelse(x %in% c("0/0","0|0"), "REF",
  ifelse(x %in% c("1/1","1|1"), "ALT",
  ifelse(x %in% c("0/1","1/0","0|1","1|0"), "HET", NA))))
}

PA <- allele_from_gt(gt[, parentA])
PB <- allele_from_gt(gt[, parentB])

# keep only sites where parents are HOM and DIFFERENT
informative <- PA %in% c("REF","ALT") & PB %in% c("REF","ALT") & (PA != PB)

fix_i <- fix[informative, ]
PA_i  <- PA[informative]
PB_i  <- PB[informative]

nils <- setdiff(colnames(gt), c(parentA, parentB))

classify_AB <- function(S, PA, PB){
  dplyr::case_when(
    S == PA ~ "A",
    S == PB ~ "B",
    S == "HET" ~ "HET",
    TRUE ~ "NEITHER"   # will be rare now (mostly missing)
  )
}

long <- purrr::map_dfr(nils, function(s){
  S <- allele_from_gt(gt[informative, s])
  tibble(sample = s,
         cls    = classify_AB(S, PA_i, PB_i)) |>
    dplyr::bind_cols(fix_i)
}) |>
  dplyr::mutate(
    cls = factor(cls, levels = c("A","B","HET","NEITHER")),
    sample = factor(sample, levels = c(
      "Pv4B.dedup.bam","Pv4C.dedup.bam",
      "Pv7A.dedup.bam","Pv7D.dedup.bam",
      "Pv8A.dedup.bam","Pv8C.dedup.bam"))
  )

# sanity: see how much green is left
table(long$cls, useNA="ifany")

sample_levels <- c(
  "Pv4B.dedup.bam","Pv4C.dedup.bam",
  "Pv7D.dedup.bam","Pv7A.dedup.bam",
  "Pv8A.dedup.bam","Pv8C.dedup.bam"
)

# Recreate df safely
df <- long %>%
  filter(!is.na(cls) & cls != "NEITHER") %>%
  mutate(
    sample = factor(sample, levels = sample_levels),
    cls    = factor(cls, levels = c("A","B","HET"))
  )


set.seed(1)

# Chr07: 7,407,405–7,413,437 from IGV
roi <- c(7.300000, 7.500000)  # Mb

panelA <- ggplot(df, aes(x = sample, y = Mb, color = cls)) +
  # ROI band (remember: y is Mb)
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = roi[1], ymax = roi[2],
           fill = "grey50", alpha = 1, color = NA) +
  geom_point(size = 0.6, alpha = 1, shape = 15,
             position = position_jitter(width = 0.35, height = 0)) +
  scale_color_manual(values = c(A="#595a5b", B="#bf7049", HET="#9fb1d6"),
                     name = NULL, labels = c("A-like","B-like","Het")) +
  labs(x = NULL, y = "Position (Mb)", title = "Chr07 SNPs by parent-of-origin") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))

panelA

ggsave("panel_a.eps", panelA, width = 5, height = 9)

roiscan <- c(6.700000, 8.500000)
roi <- c(7.407405, 7.413437)
inrroi <- c(7.408696, 7.411351) # from the G19833 reference file

#### Zoom IN Region
df_zoom <- df %>% filter(Mb >= roiscan[1], Mb <= roiscan[2]) %>% 
  mutate(sample = factor(sample, levels = sample_levels))

panelB <- ggplot(df_zoom, aes(x = sample, y = Mb, color = cls)) +
  # ROI band (remember: y is Mb)
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = inrroi[1], ymax = inrroi[2],
           fill = "grey50", alpha = 1, color = NA) +
  geom_point(size = 0.6, alpha = 1, shape = 15,
             position = position_jitter(width = 0.35, height = 0)) +
  scale_color_manual(values = c(A="#595a5b", B="#bf7049", HET="#9fb1d6"),
                     name = NULL, labels = c("A-like","B-like","Het")) +
  labs(x = NULL, y = "Position (Mb)", title = "Chr07 SNPs by parent-of-origin") +
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))

panelB

ggsave("panel_b.eps", panelB, width = 5, height = 9)
```

``` {r ROI Plot}

#This is the bash script to generate the TSV's to make a plot for the deletion

#mkdir -p depth_roi
#REGION="Chr07:7407405-7413437"

#for s in Pv4B Pv4C Pv7A Pv7D Pv8A Pv8C Pv250 Pv63H; do
# samtools depth -a -r "$REGION" "${s}.dedup.bam" > depth_roi/${s}.tsv
#done

pacman::p_load(readr, purrr)

# 1) Where the TSVs are. If you don't use a subfolder, set "."
depth_dir <- "."

# 2) Find the files (accept .tsv or .tsv.gz)
depth_files <- list.files(depth_dir, pattern = "\\.tsv(\\.gz)?$", full.names = TRUE)
if (length(depth_files) == 0) stop("No depth files found. Check depth_dir or pattern.")

# 3) Reader that forces 3 columns (no header!) and adds sample + Mb
read_depth <- function(f){
  read_tsv(
    f,
    col_names = c("CHROM","POS","DP"),   # <-- critical: NO HEADER in files
    col_types = cols(CHROM = col_character(),
                     POS   = col_integer(),
                     DP    = col_double()),
    progress = FALSE
  ) |>
    mutate(
      sample = str_remove(basename(f), "\\.tsv(\\.gz)?$"),
      Mb = POS / 1e6
    )
}

cov <- map_dfr(depth_files, read_depth)

# Quick sanity checks
print(depth_files)
print(head(cov))
cat("Chrom names in files:", paste(unique(cov$CHROM), collapse = ", "), "\n")
cov %>% count(sample) %>% print(n = Inf)

# IGV ROI: 7,407,405–7,413,437
roi <- c(7.407405, 7.413437)
inrroi <- c(7.408696, 7.411351) # from the G19833 reference file

cov_roi <- cov %>%
  filter(CHROM == "Chr07", Mb >= roi[1], Mb <= roi[2])

# If this is empty, check spelling & case of CHROM and roi units (Mb)
if (nrow(cov_roi) == 0) {
  message("cov_roi is empty. Debug info:")
  print(unique(cov$CHROM))
  print(range(cov$Mb))
  stop("CHROM name or ROI range mismatch. Make sure CHROM=='Chr07' and roi is in Mb.")
}

# Order tracks to match SNP panels
cov_roi$sample <- factor(
  cov_roi$sample,
  levels = c("Pv250","Pv63H","Pv4B","Pv4C","Pv7A","Pv7D","Pv8A","Pv8C")
)

# Coverage plot (one row per sample) with large ROI
roi <- ggplot(cov_roi, aes(x = Mb, y = DP)) +
  geom_line() +                    # or geom_area() for filled effect
  facet_grid(sample ~ ., scales = "free_y", switch = "y") +
  labs(x = "Position (Mb)", y = "Depth",
       title = sprintf("Chr07 coverage: %.3f–%.3f Mb", roi[1], roi[2])) +
  theme_bw()

print(roi)
ggsave("coverage_large_roi.eps", roi)



#### INR only

order_samples <- c("Pv250","Pv63H","Pv4B","Pv4C","Pv7A","Pv7D","Pv8A","Pv8C")
# If cov sample names have suffixes (e.g. .dedup.bam), adapt:

cov_roi <- cov %>%                     # cov = full depth table created earlier
  filter(CHROM == "Chr07", Mb >= inrroi[1], Mb <= inrroi[2]) %>%
  mutate(sample = factor(sample, levels = order_samples)) %>%
  # drop any samples not present (defensive)
  filter(!is.na(sample))

# quick sanity check
if(nrow(cov_roi)==0) stop("cov_roi is empty — check CHROM name, Mb range, or cov data")

# 1) Coverage panel with read depth of JUST INR
depthplot <- ggplot(cov_roi, aes(x = Mb, y = DP)) +
  geom_line(size = 0.4) +                     # line per sample
  facet_grid(sample ~ ., scales = "free_y", switch = "y") +
  labs(x = "Position (Mb)", y = "Depth",
       title = sprintf("Chr07 coverage: %.6f–%.6f Mb (INR)", inrroi[1], inrroi[2])) +
  theme_linedraw() +
  theme(
    strip.text.y = element_text(angle = 0),   # nicer sample labels
    panel.grid.minor = element_blank()
  )

# Print it:
print(depthplot)

ggsave("coverage_inr.eps", depthplot)

```
